(function(){window.Topics={replies_per_page:50,appendImageFromUpload:function(e){var t,n,r,i,s,o,u,a;o=$(".topic_editor"),n=o.caretPos(),s="";for(u=0,a=e.length;u<a;u++)i=e[u],s="![]("+i+")\n";return r=o.val(),t=r.slice(0,n),o.val(t+s+r.slice(n+1,r.count)),o.caretPos(n+s.length),o.focus()},initUploader:function(){var e;return $("#topic_add_image").bind("click",function(){return $("#topic_upload_images").click(),!1}),e={url:"/photos",type:"POST",beforeSend:function(){return $("#topic_add_image").hide(),$("#topic_add_image").before("<span class='loading'>上传中...</span>")},success:function(e,t,n){return $("#topic_add_image").parent().find("span").remove(),$("#topic_add_image").show(),Topics.appendImageFromUpload([e])}},$("#topic_upload_images").fileUpload(e),!1},reply:function(e,t){var n,r;return r=$("#reply_body"),n="#"+e+"楼 @"+t+" ",r.val().trim().length===0?n+="":n="\n"+n,r.focus().val(r.val()+n),!1},pageOfFloor:function(e){return Math.floor((e-1)/Topics.replies_per_page)+1},gotoFloor:function(e){var t,n,r;return n=$("#reply"+e),n.length>0?Topics.highlightReply(n):(t=Topics.pageOfFloor(e),r=window.location.pathname+("?page="+t)+("#reply"+e),App.gotoUrl(r)),n},highlightReply:function(e){return $("#replies .reply").removeClass("light"),e.addClass("light")},checkRepliesLikeStatus:function(e){var t,n,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],t=$("#replies a.likeable[data-id="+n+"]"),s.push(App.likeableAsLiked(t));return s},replyCallback:function(e,t){return $("#main .alert-message").remove(),e?($("abbr.timeago",$("#replies .reply").last()).timeago(),$("abbr.timeago",$("#replies .total")).timeago(),$("#new_reply textarea").val(""),$("#preview").text(""),App.notice(t,"#reply")):App.alert(t,"#reply"),$("#new_reply textarea").focus(),$("#btn_reply").button("reset")},preview:function(e){return $("#preview").text("Loading..."),$.post("/topics/preview",{body:e},function(e){return $("#preview").html(e.body)},"json")},hookPreview:function(e,t){var n;return n=$(document.createElement("div")).attr("id","preview"),n.addClass("body"),$(t).after(n),n.hide(),$(".edit a",e).click(function(){return $(".preview",e).removeClass("active"),$(this).parent().addClass("active"),$(n).hide(),$(t).show(),!1}),$(".preview a",e).click(function(){return $(".edit",e).removeClass("active"),$(this).parent().addClass("active"),$(n).show(),$(t).hide(),Topics.preview($(t).val()),!1})},initCloseWarning:function(e,t){return e.length===0?!1:(t||(t="离开本页面将丢失未保存页面!"),$("input[type=submit]").click(function(){return $(window).unbind("beforeunload")}),e.change(function(){return e.val().length>0?$(window).bind("beforeunload",function(e){return $.browser.msie?e.returnValue=t:t}):$(window).unbind("beforeunload")}))},favorite:function(e){var t,n;return n=$(e).data("id"),$(e).hasClass("small_bookmarked")?(t={type:"unfavorite"},$.ajax({url:"/topics/"+n+"/favorite",data:t,type:"POST"}),$(e).attr("title","收藏"),$(e).attr("class","icon small_bookmark")):($.post("/topics/"+n+"/favorite"),$(e).attr("title","取消收藏"),$(e).attr("class","icon small_bookmarked")),!1},follow:function(e){var t,n;return n=$(e).data("id"),t=$(e).data("followed"),t?($.ajax({url:"/topics/"+n+"/unfollow",type:"POST"}),$(e).data("followed",!1),$("i",e).attr("class","icon small_follow")):($.ajax({url:"/topics/"+n+"/follow",type:"POST"}),$(e).data("followed",!0),$("i",e).attr("class","icon small_followed")),!1}},$(document).ready(function(){var e,t;return e=$("body"),$("textarea").keydown(function(e){if(e.ctrlKey&&e.keyCode===13)return $("#reply > form").submit()}),Topics.initCloseWarning($("textarea.closewarning")),$("textarea").autogrow(),$("#new_reply").submit(function(){return $("#btn_reply").button("loading")}),Topics.initUploader(),$("document").on("click","a.at_floor",function(e){var t;return t=$(this).data("floor"),Topics.gotoFloor(t)}),t=window.location.hash.match(/^#reply(\d+)$/),t!=null&&Topics.highlightReply($("#reply"+t[1])),$("document").on("click","a.small_reply",function(){return Topics.reply($(this).data("floor"),$(this).attr("data-login"))}),Topics.hookPreview($(".editor_toolbar"),$(".topic_editor")),e.keydown(function(e){if(e.ctrlKey&&e.keyCode===77)return $("#markdown_help_tip_modal").modal({keyboard:!0,backdrop:!0,show:!0})})})}).call(this);